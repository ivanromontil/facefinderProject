<!DOCTYPE html>
<html>
<head>
    <title>Detect Faces Sample</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
</head>
<body>
<h1>Detect Faces:</h1>
Enter the URL to an image that includes a face or faces, then click
the <strong>Analyze face</strong> button.<br><br>
Image to analyze: <input type="text" name="inputImage" id="inputImage"
                         value="https://upload.wikimedia.org/wikipedia/commons/c/c3/RH_Louise_Lillian_Gish.jpg"/>
<button onclick="processImage()">Analyze face</button><br><br>
<div id="wrapper" style="width:1020px; display:table;">
    <div id="jsonOutput" style="width:600px; display:table-cell;">
        Response:<br><br>
        <textarea id="responseTextArea" class="UIInput"
                  style="width:580px; height:400px;"></textarea>
    </div>
    <div id="imageDiv" style="width:420px; display:table-cell;">
        Source image:<br><br>
        <canvas id="canvas" width="400"></canvas>
        <img id="sourceImage" width="400"/>
    </div>
</div>

<script>
    async function sendDataToCosmosDB(url) {
        try {
            const response = await fetch('/api/createEntry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url })
            });

            if (response.ok) {
                const result = await response.json();
                console.log('URL sent to Cosmos DB:', result);
            } else {
                throw new Error('Failed to send URL to Cosmos DB');
            }
        } catch (error) {
            console.error(error);
            alert('Error sending URL to Cosmos DB');
        }
    }

    function processImage() {
        var subscriptionKey = "1c8a0938df024623a98b21251f299565";
        var uriBase = "https://feelfinderai.cognitiveservices.azure.com/face/v1.0/detect";

        var params = {
            "detectionModel": "detection_03",
            "returnFaceId": "true"
        };

        var sourceImageUrl = document.getElementById("inputImage").value;
        document.querySelector("#sourceImage").src = sourceImageUrl;

        $.ajax({
            url: uriBase + "?" + $.param(params),
            beforeSend: function (xhrObj) {
                xhrObj.setRequestHeader("Content-Type", "application/json");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
            },
            type: "POST",
            data: '{"url": ' + '"' + sourceImageUrl + '"}',
        })
        .done(function (data) {
            $("#responseTextArea").val(JSON.stringify(data, null, 2));

            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");
            context.clearRect(0, 0, canvas.width, canvas.height);
            var img = document.getElementById('sourceImage');
            canvas.width = img.width*2;
            canvas.height = img.height*2;
            context.drawImage(img, 0, 0);
            context.strokeStyle = 'red';
            context.lineWidth = 2;
            data.forEach(function (face) {
                var faceRectangle = face.faceRectangle;
                context.beginPath();
                context.rect(faceRectangle.left, faceRectangle.top, faceRectangle.width, faceRectangle.height);
                context.stroke();
            });

            sendDataToCosmosDB(sourceImageUrl);
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
            var errorString = (errorThrown === "") ? "Error. " : errorThrown + " (" + jqXHR.status + "): ";
            errorString += (jqXHR.responseText === "") ? "" : (jQuery.parseJSON(jqXHR.responseText).message) ? jQuery.parseJSON(jqXHR.responseText).message : jQuery.parseJSON(jqXHR.responseText).error.message;
            alert(errorString);
        });
    }
</script>


<h1>Static Web Apps Database Connections</h1>
<blockquote>
    Open the console in the browser developer tools to see the API responses.
</blockquote>
<div>
    <button id="list" onclick="list()">List</button>
    <button id="get" onclick="get()">Get</button>
    <button id="update" onclick="update()">Update</button>
    <button id="create" onclick="create()">Create</button>
    <button id="delete" onclick="del()">Delete</button>
</div>
<script>
    async function list() {
        const query = `
            {
            people {
                items {
                id
                Name
                }
            }
            }`;
            
        const endpoint = "/data-api/graphql";
        const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query })
        });
        const result = await response.json();
        console.table(result.data.people.items);
    }

    async function get() {

const id = '1';

const gql = `
  query getById($id: ID!) {
    person_by_pk(id: $id) {
      id
      Name
    }
  }`;

    const query = {
        query: gql,
        variables: {
            id: id,
        },
        };

        const endpoint = "/data-api/graphql";
        const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(query),
        });
        const result = await response.json();
        console.table(result.data.person_by_pk);
    }

    async function update() {

        const id = '1';
        const data = {
        id: id,
        Name: "Molly"
        };

        const gql = `
        mutation update($id: ID!, $_partitionKeyValue: String!, $item: UpdatePersonInput!) {
            updatePerson(id: $id, _partitionKeyValue: $_partitionKeyValue, item: $item) {
            id
            Name
            }
        }`;

        const query = {
        query: gql,
        variables: {
            id: id,
            _partitionKeyValue: id,
            item: data
        } 
        };

        const endpoint = "/data-api/graphql";
        const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(query)
        });

        const result = await res.json();
        console.table(result.data.updatePerson);
    }

    async function create() {

        const data = {
        id: "3",
        Name: "Pedro"
        };

        const gql = `
        mutation create($item: CreatePersonInput!) {
            createPerson(item: $item) {
            id
            Name
            }
        }`;

        const query = {
        query: gql,
        variables: {
            item: data
        } 
        };

        const endpoint = "/data-api/graphql";
        const result = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(query)
        });

        const response = await result.json();
        console.table(response.data.createPerson);
    }


    async function del() {

        const id = '3';

        const gql = `
        mutation del($id: ID!, $_partitionKeyValue: String!) {
            deletePerson(id: $id, _partitionKeyValue: $_partitionKeyValue) {
            id
            }
        }`;

        const query = {
        query: gql,
        variables: {
            id: id,
        _partitionKeyValue: id
        }
        };

        const endpoint = "/data-api/graphql";
        const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(query)
        });

        const result = await response.json();
        console.log(`Record deleted: ${ JSON.stringify(result.data) }`);
    }
</script>
</body>
</html>
